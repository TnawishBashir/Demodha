@model Demodha.Models.NdcApplication
@using Demodha.Models
@using System.Linq

@{
    ViewData["Title"] = "Transfer Desk - Open Case";
    Layout = "_Layout.TransferDesk";

    // Helper function: does document exist?
    bool Has(NdcDocumentType t)
    {
        return Model.Documents != null && Model.Documents.Any(d => d.DocType == t);
    }

    // ✅ Use normal variables (NOT expression-bodied property) inside Razor
    var hasPurchaser = Model.Parties != null && Model.Parties.Any(p => p.PartyType == NdcPartyType.Purchaser);

    var okOwnerDocs =
        Has(NdcDocumentType.SellerCnicCopy) &&
        Has(NdcDocumentType.Photo1) &&
        Has(NdcDocumentType.Photo2) &&
        Has(NdcDocumentType.ApplicationToSecretary);

    var okChallan = Has(NdcDocumentType.PaymentChallanForm);
    var okSellerConsent = Has(NdcDocumentType.SellerConsentForm);
    var okPurchaserConsent = !hasPurchaser || Has(NdcDocumentType.PurchaserConsentForm);
    var okEStamp = Has(NdcDocumentType.EStampPaper);

    var allOk = okOwnerDocs && okChallan && okSellerConsent && okPurchaserConsent && okEStamp;
}

@if (TempData["success"] != null)
{
    <div class="alert alert-success rounded-4">@TempData["success"]</div>
}
@if (TempData["error"] != null)
{
    <div class="alert alert-danger rounded-4">@TempData["error"]</div>
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h3 class="fw-bold mb-1">Transfer Desk - Case</h3>
        <div class="text-muted">Verify all documents + e-Stamp, then send to directorates.</div>
    </div>
    <a class="btn btn-outline-secondary" href="/Home/TransferDeskDashboard">Back</a>
</div>

<div class="border rounded-4 p-3 bg-white mb-3">
    <div class="fw-bold mb-2">Step-3 Checklist</div>

    <div class="d-flex flex-wrap gap-2">
        <span class="badge @(okOwnerDocs ? "bg-success" : "bg-secondary")">Owner Docs: @(okOwnerDocs ? "OK" : "Missing")</span>
        <span class="badge @(okChallan ? "bg-success" : "bg-secondary")">Challan: @(okChallan ? "OK" : "Missing")</span>
        <span class="badge @(okSellerConsent ? "bg-success" : "bg-secondary")">Seller Consent: @(okSellerConsent ? "OK" : "Missing")</span>
        <span class="badge @(okPurchaserConsent ? "bg-success" : "bg-secondary")">Purchaser Consent: @(okPurchaserConsent ? "OK" : "Missing")</span>
        <span class="badge @(okEStamp ? "bg-success" : "bg-secondary")">e-Stamp: @(okEStamp ? "OK" : "Missing")</span>
    </div>

    <div class="mt-2">
        <span class="badge bg-primary">Stage: @Model.CurrentStage</span>
        <span class="badge bg-info text-dark">Status: @Model.CurrentStatus</span>
    </div>
</div>

<div class="row g-3">
    <div class="col-12 col-lg-6">
        <div class="border rounded-4 p-3 bg-white">
            <div class="fw-bold mb-2">Upload / Verify e-Stamp</div>

            <form method="post" enctype="multipart/form-data"
                  asp-action="UploadEStamp"
                  asp-controller="TransferDeskApplications"
                  asp-route-id="@Model.Id">
                @Html.AntiForgeryToken()

                <input type="file" name="eStampFile" class="form-control" />
                <button class="btn btn-primary mt-2" type="submit">Upload e-Stamp</button>
            </form>

            <div class="text-muted small mt-2">
                Requirement: e-Stamp paper verification must be attached before sending to directorates.
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="border rounded-4 p-3 bg-white">
            <div class="fw-bold mb-2">Send to Directorates</div>

            <form method="post"
                  asp-action="SendToDirectorates"
                  asp-controller="TransferDeskApplications"
                  asp-route-id="@Model.Id">
                @Html.AntiForgeryToken()

                <button class="btn btn-success" type="submit" @(allOk ? "" : "disabled")>
                    Send to Record + Legal + Land + Plans + BC + Finance
                </button>

                @if (!allOk)
                {
                    <div class="text-danger small mt-2">
                        Cannot send: missing required items in Step-3 checklist.
                    </div>
                }
            </form>
        </div>
    </div>
</div>

<div class="border rounded-4 p-3 bg-white mt-3">
    <div class="fw-bold mb-2">Quick Documents</div>

    @if (Model.Documents == null || !Model.Documents.Any())
    {
        <div class="text-muted">No documents uploaded yet.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead>
                    <tr class="text-muted">
                        <th>Type</th>
                        <th>File</th>
                        <th class="text-end">Open</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var d in Model.Documents.OrderByDescending(x => x.UploadedOn))
                    {
                        <tr>
                            <td>@d.DocType</td>
                            <td class="text-muted small">@d.FileName</td>
                            <td class="text-end">
                                @if (!string.IsNullOrWhiteSpace(d.FilePath))
                                {
                                    <a class="btn btn-sm btn-outline-primary" target="_blank" href="@d.FilePath">View</a>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
